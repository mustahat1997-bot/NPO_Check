<!DOCTYPE html>
<html>
<head>
<title>Cheek Affiliates </title>
<style>
:root {
    --bg-color: #121212;
    --card-bg: #1e1e1e;
    --text-color: #e0e0e0;
    --border-color: #333;
    --button-green: #4caf50;
    --button-hover: #45a049;
    --button-red: #f44336;
    --button-red-hover: #e53935;
    --copy-blue: #2196f3;
    --copy-hover: #1976d2;
    --title-color: #ff9800;
    --label-red: #f44336;
}

body {
    display:flex;
    justify-content:center;
    align-items:flex-start;
    min-height:100vh;
    font-family:Arial, sans-serif;
    background:var(--bg-color);
    color:var(--text-color);
    padding:20px;
    transition: all 0.3s ease;
}

body.light {
    --bg-color: #eef4f1;
    --card-bg: #ffffff;
    --text-color: #222;
    --border-color: #ccc;
}

.container {
    width:720px;
    background:var(--card-bg);
    padding:25px;
    border-radius:14px;
    box-shadow:0 8px 20px rgba(0,0,0,0.5);
    transition: all 0.3s ease;
    position:relative;
}

.darkmode-btn {
    position:absolute;
    top:10px;
    left:10px;
    font-size:20px;
    cursor:pointer;
    background:transparent;
    border:none;
    color:var(--text-color);
}

.page-title {
    text-align:center;
    font-size:36px;
    font-weight:bold;
    color:var(--title-color);
    margin-bottom:25px;
}

h2 {
    text-align:center;
    margin-bottom:20px;
    color:var(--text-color);
    font-weight:600;
    border-top:4px solid var(--button-green);
    padding-top:10px;
}

.center-buttons {
    text-align:center;
    margin-bottom:15px;
}

textarea, select {
    width:100%;
    padding:10px;
    border-radius:6px;
    border:1px solid var(--border-color);
    background: #2c2c2c;
    color:var(--text-color);
    font-size:14px;
   
}

body.light textarea, body.light select {
    background: #fff;
    color: var(--text-color);
}

button {
    padding:6px 8px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-size:12px;
    white-space:nowrap;
    transition: all 0.2s ease;
    font-family:Arial, sans-serif;
}

button:hover { opacity:0.9; }

.main-btn { 
    background:var(--button-green); 
    color:white; 
    font-weight:bold; 
    text-align:center; 
}

.result-box {
    margin-top:20px;
    padding:15px;
    border:1px solid var(--border-color);
    border-radius:10px;
    background:#1c1c1c;
    font-size:14px;
    transition: all 0.3s ease;
    text-align:left;
}

body.light .result-box { background:#fefefe; }

.point-block {
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    padding:12px 18px;
    margin-bottom:15px;
    border-bottom:1px dashed var(--border-color);
    border-radius:10px;
    background:#2c2c2c;
    transition: all 0.2s ease;
}

body.light .point-block { background:#f7f7f7; }

.point-block:hover { background:#333; }
body.light .point-block:hover { background:#eee; }

.point-info {
    flex:1;
    font-size:14px;
    text-align:left;
}

.point-info .not-found {
    color: var(--label-red);
    font-weight: bold;
}

.buttons-column {
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:5px;
}

.buttons-column button {
    width:200px;
    min-width:120px;
    font-weight:bold; /* bold */
    text-align:center;
    font-size:12px; /* ŸÜŸÅÿ≥ ÿ≠ÿ¨ŸÖ Apply Special Action */
}

.no-action-btn {
    background:var(--button-red);
    color:white;
    font-weight: bold !important;
    font-size: 12px !important;
    text-align: center !important;
    width:200px;      
}
.no-action-btn.active {
    background:#b71c1c; /* ŸÑŸàŸÜ ŸÖÿÆÿ™ŸÑŸÅ ÿπŸÜÿØ ÿßŸÑÿ™ŸÅÿπŸäŸÑ */
}

.no-action-btn:hover { 
    background:var(--button-red-hover); 
}

.special-select {
    width:200px;
    padding:6px 8px;
    border-radius:6px;
    border:none;
    background:var(--button-green);
    color:white;
    font-weight:bold;
    text-align:center;
    cursor:pointer;
    font-family:Arial, sans-serif;
}

.special-select option {
    background: var(--card-bg);
    color: var(--text-color);
    text-align:left;
    font-family:Arial, sans-serif;
}

.copy-container { text-align:left; margin-bottom:8px; }

.copy-btn {
    font-size:12px;
    padding:5px 12px;
    background:var(--copy-blue);
    border-radius:15px;
    color:white;
    cursor:pointer;
}

.copy-btn:hover { background:var(--copy-hover); }

.copy-only {
    font-family:Arial, sans-serif;
    font-size:14px;
    margin-top:10px;
}

.copy-only strong { color:#2196f3; font-weight:bold; }
.copy-only span.not-found { color:#f44336; font-weight:bold; }

#excelInput { display:none; }
#selectedFileName { margin-top:5px; font-size:12px; color:var(--button-green); text-align:center; }

/* ÿÆÿµŸäÿµŸãÿß ŸÇÿßÿ¶ŸÖÿ© Step 2 */
form select[name="rule"] {
    text-align: center;       /* ÿßŸÑŸÜÿµ ÿ®ÿßŸÑŸàÿ≥ÿ∑ */
    text-align-last: center;  /* ŸÑÿ∂ŸÖÿßŸÜ ÿßŸÑÿ∏ŸáŸàÿ± ÿ®ÿßŸÑŸàÿ≥ÿ∑ ŸÅŸä Firefox */
}
</style>
</head>
<body>
<div class="container">
<div class="page-title">Cheek Affiliates & Apply rules</div>
<button class="darkmode-btn" onclick="toggleDarkLight()">üåô</button>

<h2>Update Database</h2>
<form method="POST" enctype="multipart/form-data" id="uploadForm">
<input type="hidden" name="action" value="update_db">
<input type="file" id="excelInput" name="excel_file" accept=".xlsx" required>
<div class="center-buttons">
<button type="button" class="main-btn" onclick="document.getElementById('excelInput').click()">Upload & Update Database</button>
</div>
<div id="selectedFileName"></div>
</form>

{% if message %}
<div style="margin-top:10px;color:#4caf50;text-align:center;">{{ message }}</div>
{% endif %}

<h2>Step 1: Get Actions</h2>
<form method="POST">
<textarea name="points" rows="4" placeholder="Enter POINT(s) each in new line"></textarea>
<br><br>
<div class="center-buttons">
<button name="action" value="get_actions" class="main-btn">Get Actions</button>
</div>
</form>

{% if point_result %}
<div class="result-box">
<div class="copy-container">
<button type="button" class="copy-btn" onclick="copyResults()">Copy</button>
</div>
<div id="resultsContent">
{% for item in point_result %}
<div class="point-block">
<div class="point-info">
<strong>{{ loop.index }}/{{ total_points }} - POINT {{ loop.index }}: {{ item.point }}</strong><br>
{% if item.not_found %}
<span class="not-found">Point not found</span>
{% else %}
REPEATER: {{ item.repeater }}<br>
Province: {{ item.province }}<br>
Q Action: {{ item.q_action }}<br>
R Action: {{ item.r_action }}<br>
Q Action Repeater: {{ item.q_action_repeater }}
{% endif %}
</div>
{% if not item.not_found %}
<div class="buttons-column">
<button type="button" class="no-action-btn" onclick="toggleNoAction({{ loop.index0 }}, this)">No Action Needed</button>
<select class="special-select" onchange="setSpecialRule({{ loop.index0 }})" id="specialRule-{{ loop.index0 }}">
<option disabled selected>Apply Special Action</option>
<option value="(+80%) International & Local CDN 100%">(+80%) International & Local CDN 100%</option>
<option value="(+80%) International">(+80%) International</option>
<option value="150% Int. & 150% Local & 60% Bag CDN">150% Int. & 150% Local & 60% Bag CDN</option>
<option value="(+100%) All">(+100%) All</option>
<option value="(+100%) International & Local CDN 100%">(+100%) International & Local CDN 100%</option>
<option value="(+1000%) All">(+1000%) All</option>
<option value="80% Int. & 100% Local & 60% Bag CDN">80% Int. & 100% Local & 60% Bag CDN</option>
<option value="(-50%) & 0.1 Share without BGD-CDN">(-50%) & 0.1 Share without BGD-CDN</option>
<option value="(-50%) without BGD-CDN">(-50%) without BGD-CDN</option>
<option value="(-80%) & 0.1 Share without BGD-CDN">(-80%) & 0.1 Share without BGD-CDN</option>
<option value="Faw Rule">Faw Rule</option>
</select>
</div>
{% endif %}
</div>
{% endfor %}
</div>
</div>
{% endif %}

<h2>Step 2: Apply Rule For All Affiliates</h2>
<form method="POST">
<select name="rule">
<option value="(+80%) International & Local CDN 100%">(+80%) International & Local CDN 100%</option>
<option value="(+80%) International">(+80%) International</option>
<option value="150% Int. & 150% Local & 60% Bag CDN">150% Int. & 150% Local & 60% Bag CDN</option>
<option value="(+100%) All">(+100%) All</option>
<option value="(+100%) International & Local CDN 100%">(+100%) International & Local CDN 100%</option>
<option value="(+1000%) All">(+1000%) All</option>
<option value="80% Int. & 100% Local & 60% Bag CDN">80% Int. & 100% Local & 60% Bag CDN</option>
<option value="(-50%) & 0.1 Share without BGD-CDN">(-50%) & 0.1 Share without BGD-CDN</option>
<option value="(-50%) without BGD-CDN">(-50%) without BGD-CDN</option>
<option value="(-80%) & 0.1 Share without BGD-CDN">(-80%) & 0.1 Share without BGD-CDN</option>
<option value="Faw Rule">Faw Rule</option>
</select>
<br><br>
<div class="center-buttons">
<button name="action" value="apply_rule" class="main-btn">Apply Rule & Generate Excel</button>
</div>
</form>
</div>

<script>
const excelInput = document.getElementById("excelInput");
const selectedFileName = document.getElementById("selectedFileName");
excelInput.addEventListener("change", () => {
    if(excelInput.files.length > 0){
        selectedFileName.textContent = excelInput.files[0].name;
        document.getElementById("uploadForm").submit();
    }
});

function setSpecialRule(index){
    const select = document.getElementById("specialRule-" + index);
    const selectedRule = select.value;
    fetch("/set_special_rule/" + index, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({rule: selectedRule})
    });
}

function toggleNoAction(index, btn){
    const step1_results = {{ step1_results|tojson|safe }};
    
    // ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ®ŸäŸÜ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸàÿßŸÑÿ•ŸÑÿ∫ÿßÿ°
    if(btn.classList.contains("active")){
        btn.classList.remove("active");
        btn.innerText = "No Action Needed";
        fetch("/mark_no_action/" + index, {
            method:"POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({undo:true})
        });
    } else {
        btn.classList.add("active");
        btn.innerText = "No Action ‚úÖ";
        fetch("/mark_no_action/" + index, {method:"POST"});
    }
}

function copyResults(){
    const copyDivs = document.querySelectorAll(".point-info");
    const text = Array.from(copyDivs).map(d => d.innerText.trim()).join("\n----------------\n\n");
    let textarea = document.createElement("textarea");
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand("copy");
    document.body.removeChild(textarea);
    const btn = document.querySelector(".copy-btn");
    btn.innerText = "Copied ‚úÖ";
    setTimeout(()=>{ btn.innerText="Copy"; }, 1500);
}

function toggleDarkLight(){
    document.body.classList.toggle("light");
}
</script>
</body>
</html>